<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" type="text/css" href="./swal_toast.css"/>


    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" id="bootstrap_min_css">
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" id="bootstrap_min_js"></script>
 -->
    <link rel='stylesheet' href='//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css'>


    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css'>

    <script src="https://strouroul.github.io/portifolio/porti2/js/iconify.min.js"></script>


    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!--  <script src="/LAYOUT/call_center/js/vanilla-toast.js"></script>-->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- <style>
         * {
             box-sizing: border-box;
         }

         input[type=text], select, textarea {
             width: 100%;
             padding: 12px;
             border: 1px solid #ccc;
             border-radius: 4px;
             resize: vertical;
         }

         label {
             padding: 12px 12px 12px 0;
             display: inline-block;
         }

         input[type=submit] {
             background-color: #04AA6D;
             color: white;
             padding: 12px 20px;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             float: right;
         }

         input[type=submit]:hover {
             background-color: #45a049;
         }

         .container {
             border-radius: 5px;
             background-color: #f2f2f2;
             padding: 20px;
         }

         .col-25 {
             float: left;
             width: 25%;
             margin-top: 6px;
         }

         .col-75 {
             float: left;
             width: 75%;
             margin-top: 6px;
         }

         /* Clear floats after the columns */
         .row:after {
             content: "";
             display: table;
             clear: both;
         }

         /* Responsive layout - when the screen is less than 600px wide, make the two columns stack on top of each other instead of next to each other */
         @media screen and (max-width: 600px) {
             .col-25, .col-75, input[type=submit] {
                 width: 100%;
                 margin-top: 0;
             }
         }
     </style>-->

    <!--
        <style>
            /*
            body {
                padding : 10px ;

            }*/

            #exTab1 .tab-content {
                color : white;
                background-color: #428bca;
                padding : 0px 5px;
            }

            #exTab2 h3 {
                color : white;
                background-color: #428bca;
                padding : 5px 15px;
            }

            /* remove border radius for the tab */

            #exTab1 .nav-pills > li > a {
                border-radius: 0;
            }

            /* change border radius for the tab , apply corners on top*/

            #exTab3 .nav-pills > li > a {
                border-radius: 4px 4px 0 0 ;
            }

            #exTab3 .tab-content {
                color : white;
                background-color: #428bca;
                padding : 5px 15px;
            }




            html, body, #exTab1, .tab-content, .tab-pane {
                height: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                overflow-x: scroll;
                overflow-y: scroll;
            }

            #3a {
                height: 100vh; /* Full viewport height */
                width: 100%;
                overflow-x: scroll;
                overflow-y: scroll;
            }

            #3a iframe {
                height: 100%;
                width: 100%;
                border: none;
                overflow-x: scroll;
                overflow-y: scroll;
            }

        </style>-->


    <style>
       /* html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }*/

        #exTab1 {
            position: fixed; /* makes sure it ignores content height */
            top: 0;
            left: 0;
            width: 100vw;  /* 100% of viewport width */
            height: 100vh; /* 100% of viewport height */
            overflow: hidden;
        }

        .nav-pills {
            margin-bottom: 0;
        }

        .tab-content {
            height: calc(100% - 40px); /* Adjust based on nav height */
            width: 100%;
            padding: 0;
            overflow: scroll;
        }

        .tab-pane {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }



        #3a   {
            height: 100%;
            width: 100%;
            border: none;
            /* overflow: auto; /* Makes iframe scrollable */
            overflow: scroll;
            overflow-x: scroll !important;
            display: block;

        }

    </style>
</head>
<body>
<div id="exTab1" class="container"
     style="overflow-y: scroll;width:100%;height:100%;">


    <div class="tab-content clearfix" >

        <div class="tab-pane active" id="divParams">


        </div>
        <div class="tab-pane " id="2a">
            <h3>Script for Agents go here !! Could be from a URL too ?</h3>
        </div>


    </div>
</div>



</div>

<script src="./postAjax.js"></script>
<script>

    let this_lead_id=null;

    let swal_toast_showing=false;

    let keys_toHide=['pass','server_ip','state','rank'];

    let keys_readOnly=['lead_id','vendor_id','list_id',
        'gmt_offset_now','epoch','campaign','channel_group'
        ,'phone_login','owner','called_since_last_reset','called_count',
        'customer_zap_channel','group','closer',
        'security_phrase','session_id','status',
        'SIPexten','SQLdate','uniqueid','user'
    ];


    let keys_toShow=[ "address1", "address2", "address3", "alt_phone", "campaign", "channel_group",
        "city", "closer", "comments", "country_code", "date_of_birth", "email",
        "epoch", "first_name", "fronter", "gender", "gmt_offset_now", "last_name",
        "lead_id", "list_id", "middle_initial", "phone_code", "phone_login",
        "phone_number", "postal_code", "province", "security_phrase", "server_ip",
        "session_id", "SIPexten", "SQLdate", "state", "title"
    ];
    function sortAsc(arr) {
        // return arr.slice().sort(); // slice() makes a copy so original isn't modified
        const sortedKeys = arr.filter(k => k).sort((a, b) => a.localeCompare(b));
        return sortedKeys;
    }
    keys_toShow=sortAsc(keys_toShow);


    console.log(`keys_toShow : `,keys_toShow)
    function readParamsFromUrl() {
        return window.location.search.substring(1); // removes the '?'
    }
    function parseParamsFromUrl(queryString) {
        const params = {};
        if (!queryString) return params;

        const pairs = queryString.split('&');
        for (let pair of pairs) {
            const [key, value] = pair.split('=').map(decodeURIComponent);
            if (key) {
                params[key] = value || '';
            }
        }
        return params;
    }




    function generateInputFields(params_now) {
        let myParamsHtml_NOW = '';
        console.log("Full params_now object:", Object.keys(params_now).length);

        // Define your grouped layout keys
        const groupedFields = {
            row1: ['title', 'first_name', 'last_name'],
            row2: ['address1','city','province', 'state'],
            row3: [ 'postal_code'],
            row4: ['phone_code','phone_number',  'alt_phone'],
            row5: ['show', 'email'],
            row6: ['comments'],
           // row7: ['vendor_id', 'gender']
           // row7: ['vendor_id', 'gender', 'address2', 'address3' , 'middle_initial']
        };

        // Helper to render one input
        const renderInput = (key) => {
            if (!keys_toShow.includes(key) || keys_toHide.includes(key)) return '';
            return `
                <div class="col-md-${key === 'comments' ? '12' : '4'} mb-3">
                    <label for="${key}" class="form-label text-capitalize">${key.replace(/_/g, ' ')}</label>
                    ${key === 'comments'
                ? `<textarea class="form-control" id="${key}" rows="4" oninput="handleInput(this, '${key}')" ${keys_readOnly.includes(key) ? 'disabled' : ''}>${params_now[key] || ''}</textarea>
<div id="editableDiv"   style="max-height:50px;">
  This is a link: <a href="https://ishopper.info" target="_blank">ishopper.info</a>
</div>`
                : `<input type="text" class="form-control" id="${key}" name="${key}"
                            value="${key === 'phone_code' ? '1':  ''}"
                            oninput="handleInput(this, '${key}')" ${key === 'phone_code' ?  'disabled' : ''}>`}
                </div>
            `;
        };

        // Render predefined grouped fields
        Object.keys(groupedFields).forEach(row => {
            let rowContent = '';
            groupedFields[row].forEach(key => {
                if (params_now[key] !== undefined) {
                    rowContent += renderInput(key);
                    //   sortedKeys.splice(sortedKeys.indexOf(key), 1); // Remove from remaining
                }else{
                    rowContent += renderInput(key);
                }
            });
            if (rowContent) {
                myParamsHtml_NOW += `<div class="row">${rowContent}</div>`;
            }
        });

        if (params_now && Object.keys(params_now).length > 0) {
          //  const sortedKeys = Object.keys(params_now).filter(k => k).sort((a, b) => a.localeCompare(b));


            /*
            // Render remaining fields
            sortedKeys.forEach(key => {
                if (!keys_toShow.includes(key) || keys_toHide.includes(key)) return;
                myParamsHtml_NOW += `
                <div class="mb-3 row">
                    <label for="${key}" class="col-sm-3 col-form-label text-capitalize">${key.replace(/_/g, ' ')}</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="${key}" name="${key}"
                        value="${key === 'epoch' ? new Date(parseInt(params_now[key]) * 1).toLocaleString() : params_now[key] || ''}"
                        oninput="handleInput(this, '${key}')" ${keys_readOnly.includes(key) ? 'disabled' : ''}>
                    </div>
                </div>
            `;
            });*/
        }

        return myParamsHtml_NOW;
    }

    function handleInput(input, key) {
        const cursorPos = input.selectionStart;
        update_lead(key, input.value);
        input.setSelectionRange(cursorPos, cursorPos);
    }
    let query = readParamsFromUrl();
    let params = parseParamsFromUrl(query)||null;
    /*
        console.log(params);

        let myParamsHtml='';

        if(params!=null&&Object.keys(params).length>0){
            Object.keys(params).forEach(key=>{
                myParamsHtml+=`${key} : ${params[key]}<BR>`;
            })
        }
        */


    function update_lead(key, value) {
        //  console.log(`Updated ${key} to ${value}`);
        // Add your logic here, like sending an AJAX request

        if(value!==null && value!=='') {
            if (this_lead_id === null) {
                let this_lead_update_json = {

                    param_name: key,
                    param_value: value,
                }

                console.log(`GET LEAD_ID`)
                postAjax_ASYNC('https://www.ishopper.info/contact_form/add_client_lead.pl',
                    {param: JSON.stringify(this_lead_update_json)},
                    function (data) {


                        return new Promise((resolve, reject) => {
                            console.log(`Lead Update  : ${data}`);
                            let myJSON_new = JSON.parse(data);
                            if (myJSON_new != null) {


                                resolve(myJSON_new);

                            } else {
                                reject({error: "CANT FIND JSON"})
                            }
                        })


                    })
                    .then(my_DATA => {
                        if (my_DATA != null) {
                            console.log("Lead status from server : " + JSON.stringify(my_DATA));


                            if (my_DATA.hasOwnProperty('highest_lead_id')) {
                                this_lead_id=my_DATA.highest_lead_id
                                console.log("Lead status from server : ", (this_lead_id));
                                //  show_data_textboxes(my_DATA.db);
                            }


                        }


                    })
                    .catch(my_err => {
                        console.log(my_err);
                    });
            }
            else {
                let this_lead_update_json = {
                    lead_id: this_lead_id,
                    param_name: key,
                    param_value: value,
                }
                this_lead_update_json[key] = value;
                console.log(`ALREADY SET LEAD_ID : ${this_lead_id}`)
                console.log(`this_lead_update_json : `, this_lead_update_json);
                postAjax_ASYNC('https://www.ishopper.info/contact_form/add_client_lead.pl',
                    {param: JSON.stringify(this_lead_update_json)},
                    function (data) {


                        return new Promise((resolve, reject) => {
                            console.log(`Lead Update  : ${data}`);
                            let myJSON_new = JSON.parse(data);
                            if (myJSON_new != null) {


                                resolve(myJSON_new);

                            } else {
                                reject({error: "CANT FIND JSON"})
                            }
                        })


                    })
                    .then(my_DATA => {
                        if (my_DATA != null) {
                            console.log("Lead status from server : " + JSON.stringify(my_DATA));


                            if (my_DATA.hasOwnProperty('db')) {
                                console.log("Lead status from server : ", (my_DATA.db));
                                //  show_data_textboxes(my_DATA.db);
                            }


                        }


                    })
                    .catch(my_err => {
                        console.log(my_err);
                    });
            }
        }
            else{
                if(!check_swal_toast_visible()){
                    show_swal_toast('error', 'Not Updated' )
                }
                else{}

            }




    }

    function show_data_textboxes(data){
        document.getElementById('divParams').innerHTML=
            `<!--<div class="container">
  <form action="/action_page.php">`+ //  generateInputFields(data)   +
            ` </form></div>-->`

            +`<!--<div class="container ">-->
  <div class="card shadow-sm">

    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Add Lead</h5>
    </div>
    <div class="card-body  p-4" style="max-height: 100vh; overflow-y: auto;">

        ${generateInputFields(data)}

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success">Submit</button>
        </div>
    </div>

  </div>
<!--</div>-->
`
            ||"NO DATA";

        extractAndDisplayLinks();



        document.addEventListener("DOMContentLoaded", function () {
            const exTab1 = document.getElementById("exTab1");
            if (exTab1) {
                exTab1.style.width = "100%";
                exTab1.style.height = "100%";
            }
        });
    }
    function extractAndDisplayLinks() {
        if(document.getElementById('comments')){
            const textarea = document.getElementById('comments');
            const editableDiv = document.getElementById('editableDiv');
            const text = textarea.value;

            // Regex to find all URLs
            const urlRegex = /https?:\/\/[^\s]+/gi;
            const matches = text.match(urlRegex);

            if (matches) {
                const linksHtml = matches.map(url => `<a href="${url}" target="_blank">${url}</a>`).join('<br>');
                editableDiv.innerHTML = linksHtml;
            } else {
                editableDiv.innerHTML = 'No links found.';
            }
        }

    }
    show_data_textboxes(params);



</script>
</body>
</html>